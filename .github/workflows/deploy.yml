name: Deploy to Production

# –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ push –≤ main –≤–µ—Ç–∫—É
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Yandex Cloud
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout –∫–æ–¥–∞ –Ω–µ –Ω—É–∂–µ–Ω (–¥–µ–ø–ª–æ–π –¥–µ–ª–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ git pull)

      # 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–ø–ª–æ–π
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            # –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            cd /opt/bizan_site
            
            # –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            echo "üì• –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ GitHub..."
            git pull
            
            # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üê≥ –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑—ã..."
            docker-compose -f docker/docker-compose.prod.yml --env-file .env up -d --build
            
            # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: https://dev.bizan.pro"
            echo "üîß Strapi Admin: https://dev.bizan.pro/admin"

      # 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Deployment Status
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Site: https://dev.bizan.pro"
